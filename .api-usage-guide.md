# üîê Gu√≠a de Uso de API - Endpoints Seguros

## üìã Tabla de Contenidos
1. [Autenticaci√≥n](#autenticaci√≥n)
2. [Cuentas (Accounts)](#cuentas-accounts)
3. [Transacciones (Transactions)](#transacciones-transactions)
4. [C√≥digos de Error](#c√≥digos-de-error)

---

## üîë Autenticaci√≥n

Todos los endpoints requieren un token JWT v√°lido en el header:

```http
Authorization: Bearer <tu_token_jwt>
```

El token contiene:
- `userId`: ID del usuario autenticado
- `email`: Email del usuario

---

## üí∞ Cuentas (Accounts)

### 1. Crear Cuenta

**Endpoint:** `POST /accounts/create`

**Descripci√≥n:** Crea una nueva cuenta para el usuario autenticado.

**Headers:**
```http
Authorization: Bearer <token>
Content-Type: application/json
```

**Body:**
```json
{
  "name": "Cuenta de Ahorros",
  "currency": "USD",
  "balance": 1000.50,
  "icon": "üí∞"
}
```

**Respuesta Exitosa (201):**
```json
{
  "id": "uuid-generado",
  "name": "Cuenta de Ahorros",
  "currency": "USD",
  "balance": 1000.50,
  "icon": "üí∞",
  "user_id": "tu-user-id",
  "created_at": "2025-11-24T22:00:00Z",
  "updated_at": "2025-11-24T22:00:00Z"
}
```

**Notas de Seguridad:**
- ‚úÖ El `user_id` se toma autom√°ticamente del token JWT
- ‚ùå NO puedes crear cuentas para otros usuarios
- ‚úÖ El `user_id` en la respuesta siempre ser√° el tuyo

---

### 2. Actualizar Cuenta

**Endpoint:** `PUT /accounts/update/:account_id`

**Descripci√≥n:** Actualiza una cuenta existente (solo si eres el due√±o).

**Headers:**
```http
Authorization: Bearer <token>
Content-Type: application/json
```

**Par√°metros de Ruta:**
- `account_id`: ID de la cuenta a actualizar

**Body:**
```json
{
  "name": "Cuenta de Ahorros Premium",
  "currency": "EUR",
  "balance": 2000.00
}
```

**Respuesta Exitosa (200):**
```json
{
  "id": "account-id",
  "name": "Cuenta de Ahorros Premium",
  "currency": "EUR",
  "balance": 2000.00,
  "user_id": "tu-user-id",
  "updated_at": "2025-11-24T22:05:00Z"
}
```

**Errores Posibles:**
- `404 Not Found`: La cuenta no existe
- `403 Forbidden`: La cuenta no te pertenece

**Ejemplo de Error (403):**
```json
{
  "statusCode": 403,
  "message": "No tienes permiso para modificar esta cuenta"
}
```

**Notas de Seguridad:**
- ‚úÖ Solo puedes actualizar tus propias cuentas
- ‚úÖ El sistema valida que `account.user_id === tu_user_id`
- ‚ùå Intentar actualizar una cuenta ajena resulta en error 403

---

### 3. Obtener Todas las Cuentas

**Endpoint:** `GET /accounts/get/all`

**Descripci√≥n:** Obtiene todas las cuentas del usuario autenticado.

**Headers:**
```http
Authorization: Bearer <token>
```

**Respuesta Exitosa (200):**
```json
[
  {
    "id": "account-1",
    "name": "Cuenta de Ahorros",
    "currency": "USD",
    "balance": 1000.50,
    "user_id": "tu-user-id",
    "created_at": "2025-11-24T22:00:00Z"
  },
  {
    "id": "account-2",
    "name": "Cuenta Corriente",
    "currency": "EUR",
    "balance": 500.00,
    "user_id": "tu-user-id",
    "created_at": "2025-11-24T22:01:00Z"
  }
]
```

**Notas de Seguridad:**
- ‚úÖ Solo ves tus propias cuentas
- ‚úÖ El `user_id` del token se usa autom√°ticamente
- ‚ùå No puedes ver cuentas de otros usuarios

---

## üí∏ Transacciones (Transactions)

### 1. Crear Transacci√≥n

**Endpoint:** `POST /transactions/save`

**Descripci√≥n:** Crea una nueva transacci√≥n en una de tus cuentas.

**Headers:**
```http
Authorization: Bearer <token>
Content-Type: application/json
```

**Body:**
```json
{
  "name": "Compra en supermercado",
  "amount": 50.75,
  "type": "expense",
  "account_id": "tu-account-id"
}
```

**Tipos de Transacci√≥n:**
- `saving`: Incrementa el balance
- `expense`: Decrementa el balance

**Respuesta Exitosa (201):**
```json
{
  "id": "transaction-id",
  "name": "Compra en supermercado",
  "amount": 50.75,
  "type": "expense",
  "account_id": "tu-account-id",
  "issued_at": "2025-11-24T22:10:00Z"
}
```

**Errores Posibles:**
- `404 Not Found`: La cuenta no existe
- `403 Forbidden`: La cuenta no te pertenece

**Ejemplo de Error (403):**
```json
{
  "statusCode": 403,
  "message": "No tienes permiso para crear transacciones en esta cuenta"
}
```

**Notas de Seguridad:**
- ‚úÖ Solo puedes crear transacciones en tus propias cuentas
- ‚úÖ El sistema valida que `account.user_id === tu_user_id`
- ‚ùå Intentar crear transacciones en cuentas ajenas resulta en error 403
- ‚ö†Ô∏è El balance de la cuenta se actualiza autom√°ticamente

**Ejemplo de Actualizaci√≥n de Balance:**
```
Balance inicial: 1000.00
Transacci√≥n (expense): -50.75
Balance final: 949.25
```

---

### 2. Obtener Historial de Transacciones

**Endpoint:** `GET /transactions/history`

**Descripci√≥n:** Obtiene el historial de transacciones del usuario autenticado.

**Headers:**
```http
Authorization: Bearer <token>
```

**Query Parameters (opcionales):**
- `skip`: N√∫mero de registros a saltar (default: 0)
- `take`: N√∫mero de registros a obtener (default: 10)
- `account_id`: Filtrar por cuenta espec√≠fica (opcional)

**Ejemplos de Uso:**

#### Todas las transacciones del usuario (paginado)
```http
GET /transactions/history?skip=0&take=10
```

#### Transacciones de una cuenta espec√≠fica
```http
GET /transactions/history?account_id=tu-account-id&skip=0&take=20
```

**Respuesta Exitosa (200):**
```json
[
  {
    "id": "tx-1",
    "name": "Salario",
    "amount": 3000.00,
    "type": "saving",
    "account_id": "account-1",
    "issued_at": "2025-11-24T22:00:00Z"
  },
  {
    "id": "tx-2",
    "name": "Compra en supermercado",
    "amount": 50.75,
    "type": "expense",
    "account_id": "account-1",
    "issued_at": "2025-11-24T22:10:00Z"
  }
]
```

**Notas de Seguridad:**
- ‚úÖ Solo ves transacciones de tus propias cuentas
- ‚úÖ Si especificas `account_id`, el sistema valida que sea tuya
- ‚úÖ Las transacciones se ordenan por fecha (m√°s recientes primero)
- ‚ùå No puedes ver transacciones de otros usuarios

---

## ‚ö†Ô∏è C√≥digos de Error

### 401 Unauthorized
**Causa:** Token JWT inv√°lido o expirado

**Soluci√≥n:** Renovar el token de autenticaci√≥n

```json
{
  "statusCode": 401,
  "message": "No est√°s autenticado"
}
```

---

### 403 Forbidden
**Causa:** Intentando acceder a recursos que no te pertenecen

**Soluci√≥n:** Solo accede a tus propios recursos

```json
{
  "statusCode": 403,
  "message": "No tienes permiso para acceder a esta cuenta"
}
```

---

### 404 Not Found
**Causa:** El recurso solicitado no existe

**Soluci√≥n:** Verifica que el ID sea correcto

```json
{
  "statusCode": 404,
  "message": "Cuenta no encontrada"
}
```

---

### 400 Bad Request
**Causa:** Datos inv√°lidos en el request

**Soluci√≥n:** Verifica que los datos cumplan con las validaciones

```json
{
  "statusCode": 400,
  "message": [
    "name must be longer than or equal to 3 characters",
    "balance must be a positive number"
  ]
}
```

---

## üß™ Ejemplos con cURL

### Crear Cuenta
```bash
curl -X POST http://localhost:3000/accounts/create \
  -H "Authorization: Bearer tu_token_jwt" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Mi Cuenta",
    "currency": "USD",
    "balance": 1000,
    "icon": "üí∞"
  }'
```

### Actualizar Cuenta
```bash
curl -X PUT http://localhost:3000/accounts/update/account-id \
  -H "Authorization: Bearer tu_token_jwt" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Cuenta Actualizada",
    "currency": "EUR",
    "balance": 2000
  }'
```

### Obtener Cuentas
```bash
curl -X GET http://localhost:3000/accounts/get/all \
  -H "Authorization: Bearer tu_token_jwt"
```

### Crear Transacci√≥n
```bash
curl -X POST http://localhost:3000/transactions/save \
  -H "Authorization: Bearer tu_token_jwt" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Compra",
    "amount": 50.75,
    "type": "expense",
    "account_id": "tu-account-id"
  }'
```

### Obtener Historial
```bash
curl -X GET "http://localhost:3000/transactions/history?skip=0&take=10" \
  -H "Authorization: Bearer tu_token_jwt"
```

---

## üîí Mejores Pr√°cticas de Seguridad

1. **Nunca compartas tu token JWT**
   - El token da acceso completo a tu cuenta

2. **Valida siempre las respuestas**
   - Verifica los c√≥digos de estado HTTP
   - Maneja errores apropiadamente

3. **No intentes acceder a recursos ajenos**
   - El sistema bloquear√° estos intentos
   - Podr√≠an quedar registrados en logs de auditor√≠a

4. **Usa HTTPS en producci√≥n**
   - Nunca env√≠es tokens por HTTP sin cifrar

5. **Renueva tokens regularmente**
   - Los tokens expiran en 5 d√≠as
   - Implementa refresh token si es necesario

---

## üìû Soporte

Si encuentras alg√∫n problema de seguridad, rep√≥rtalo inmediatamente al equipo de desarrollo.

**Documentos relacionados:**
- `.security-audit-report.md` - Reporte de auditor√≠a
- `.security-fixes-summary.md` - Resumen de correcciones
